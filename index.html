<!DOCTYPE html>
<html>
    <body>
        <div id="configuration">
            <div>
                <p>
                    <label for="rf-per-pulse">rfPerPulse: </label>
                    <input type="number" id="rf-per-pulse-input" name="rf-per-pulse" value="64">
                </p>
                <p>
                    <label for="absorber-rate">absorberRate: </label>
                    <input type="number" id="absorber-rate-input" name="absorber-rate" value="16">
                </p>
                <p>
                    <label for="vent-base-rate">ventBaseRate: </label>
                    <input type="number" id="vent-base-rate-input" name="vent-base-rate" value="4">
                </p>
                <p>
                    <label for="vent-relative-rate">ventRelativeRate: </label>
                    <input type="number" id="vent-relative-rate-input" name="vent-relative-rate" value="100">
                </p>
                <button onclick="updateConfig()">Update config</button>
            </div>
            <div>
                <p>
                    <label for="width">Reactor inner width: </label>
                    <input type="number" id="width-input" name="width" min="3" max="64" value="5">
                </p>
                <p>
                    <label for="height">Reactor inner height: </label>
                    <input type="number" id="height-input" name="height" min="3" max="64" value="5">
                </p>
                <p>
                    <label for="stack-height">Reactor stack height: </label>
                    <input type="number" id="stack-height-input" name="stack-height" min="1" max="64" value="5">
                </p>
                <button onclick="replaceLayout()">Replace layout</button>
            </div>
        </div>
        <p>
            <label for="component">Choose a component: </label>
            <select name="component" id="component-select" onchange="updateSelectedReactorComponentFactory()">
                <option value="0">Empty</option>
                <option value="1">Single Reactor Rod</option>
                <option value="2">Reactor Double Rod</option>
                <option value="3">Reactor Quad Rod</option>
                <option value="4">Reactor Neutron Reflector</option>
                <option value="5">Reactor Heat Absorber</option>
                <option value="6">Reactor Heat Vent</option>
                <option value="7">Reactor Heat Pipe</option>
            </select>
        </p>
        <p><button onclick="runSimulationAndPostResults()">Simulate</button></p>
        <div id="reactor-layout-wrapper"></div>
        <pre id="simulation-results"></pre>
        <canvas width="800" height="400" id="heat-history"></canvas>
    </body>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let RF_PER_PULSE = 64;
        let ABSORBER_RATE = 16;
        let VENT_BASE_RATE = 4;
        let VENT_RELATIVE_RATE = 100;

        // ATM10 values
        // const RF_PER_PULSE = 1100;
        // const ABSORBER_RATE = 64;
        // const VENT_BASE_RATE = 24;
        // const VENT_RELATIVE_RATE = 160;

        class ReactorSimulator {
            constructor(reactorLayout) {
                this.reactorLayout = reactorLayout;
                this.reactorHeatLayout = [];
                this.maxHeatHistory = [];

                for (let j = 0; j < reactorLayout.height; j++) {
                    const row = [];

                    for (let i = 0; i < reactorLayout.width; i++) {
                        row.push(0);
                    }

                    this.reactorHeatLayout.push(row);
                }

                this.rfGenerated = 0;
                this.fuelConsumed = 0;
                this.coolantConsumed = 0;
            }

            getComponentHeat(componentPosition) {
                return this.reactorHeatLayout[componentPosition.y][componentPosition.x];
            }

            setComponentHeat(componentPosition, heat) {
                this.reactorHeatLayout[componentPosition.y][componentPosition.x] = heat;
            }

            addComponentHeat(componentPosition, heatDelta) {
                this.reactorHeatLayout[componentPosition.y][componentPosition.x] += heatDelta;
            }

            simulate(ticks) {
                for (let t = 0; t < ticks; t++) {
                    let tickMaxHeat = 0;

                    for (let j = 0; j < this.reactorLayout.height; j++) {
                        for (let i = 0; i < this.reactorLayout.width; i++) {
                            const componentPosition = new ReactorComponentPosition(i, j);
                            const reactorComponent = this.reactorLayout.getComponent(componentPosition);

                            reactorComponent.tick(this.reactorLayout, componentPosition, this);

                            const componentHeat = this.getComponentHeat(componentPosition);
                            if (componentHeat > tickMaxHeat) {
                                tickMaxHeat = componentHeat;
                            }
                        }
                    }

                    if (t % 1000 == 0) {
                        this.maxHeatHistory.push(tickMaxHeat);
                    }
                }
            }
        }

        class ReactorComponentPosition {
            constructor(x, y) {
                this.x = x;
                this.y = y;
            }
        }

        class ReactorLayout {
            constructor(width, height, stackHeight) {
                this.layout = [];
                this.width = width;
                this.height = height;
                this.stackHeight = stackHeight;

                for (let j = 0; j < height; j++) {
                    const row = [];

                    for (let i = 0; i < width; i++) {
                        row.push(new ReactorEmptyTile());
                    }

                    this.layout.push(row);
                }
            }

            getComponent(position) {
                return this.layout[position.y][position.x];
            }

            setComponent(position, reactorComponent) {
                this.layout[position.y][position.x] = reactorComponent;
            }
            
            getComponentNeighbours(position) {
                const neighbours = [];

                for (const [xOffset, yOffset] of [[0, -1], [1, 0], [0, 1], [-1, 0]]) {
                    const neighbourPosition = new ReactorComponentPosition(
                        position.x + xOffset,
                        position.y + yOffset
                    );

                    if (neighbourPosition.x < 0 || neighbourPosition.x >= this.width ||
                        neighbourPosition.y < 0 || neighbourPosition.y >= this.height
                    ) {
                        continue;
                    }

                    neighbours.push(neighbourPosition);
                }

                return neighbours;
            }

            getHtmlLayout() {
                const layoutTable = document.createElement("table");
                layoutTable.id = "reactor-layout";

                for (let j = 0; j < this.height; j++) {
                    const layoutTableRow = document.createElement("tr");

                    for (let i = 0; i < this.width; i++) {
                        const layoutTableCell = document.createElement("td");
                        layoutTableCell.classList.add("reactor-component");

                        layoutTableCell.addEventListener("click", () => {
                            const newReactorComponent = selectedReactorComponentFactory();
                            this.setComponent(new ReactorComponentPosition(i, j), newReactorComponent);
                            layoutTableCell.style.backgroundImage = `url('${newReactorComponent.imageUrl}')`;
                        });

                        layoutTableRow.appendChild(layoutTableCell);
                    }

                    layoutTable.appendChild(layoutTableRow);
                }

                return layoutTable;
            }
        }

        class ReactorComponent {
            constructor(imageUrl) {
                this.imageUrl = imageUrl;
            }

            tick(reactorLayout, componentPosition, simulator) { }
        }

        class ReactorEmptyTile extends ReactorComponent {
            constructor() {
                super("empty.png")
            }
        }

        class ReactorFuelRod extends ReactorComponent {
            constructor(rodCount) {
                switch (rodCount) {
                    case 1:
                        super("single rod.png");
                        break;
                    case 2:
                        super("duo rod.png");
                        break;
                    case 4:
                        super("quad rod.png");
                        break;
                    default:
                        super(null);
                }
                this.rodCount = rodCount;
            }

            getInternalPulses() {
                switch (this.rodCount) {
                    case 1:
                        return 1;
                    case 2:
                        return 4;
                    case 4:
                        return 12;
                    default:
                        return 0;
                }
            }

            tick(reactorLayout, componentPosition, simulator) {
                let receivedPulses = this.getInternalPulses();

                for (const neighbourPosition of reactorLayout.getComponentNeighbours(componentPosition)) {
                    const neighbour = reactorLayout.getComponent(neighbourPosition);

                    if (neighbour instanceof ReactorNeutronReflector) {
                        receivedPulses += this.rodCount;
                    } else if (neighbour instanceof ReactorFuelRod) {
                        receivedPulses += neighbour.rodCount;
                    }
                }

                simulator.rfGenerated += RF_PER_PULSE * receivedPulses * reactorLayout.stackHeight;
                simulator.addComponentHeat(componentPosition, receivedPulses / 2 * receivedPulses + 4);

                simulator.fuelConsumed += this.rodCount * reactorLayout.stackHeight;
            }
        }

        class ReactorNeutronReflector extends ReactorComponent {
            constructor() {
                super("reflector.png");
            }
        }

        class ReactorHeatPipe extends ReactorComponent {
            constructor() {
                super("heat pipe.png");
            }

            tick(reactorLayout, componentPosition, simulator) {
                for (const neighbourPosition of reactorLayout.getComponentNeighbours(componentPosition)) {
                    const neighbourHeat = simulator.getComponentHeat(neighbourPosition);
                    const selfHeat = simulator.getComponentHeat(componentPosition);

                    if (neighbourHeat <= selfHeat) {
                        continue;
                    }

                    const heatDiff = neighbourHeat - selfHeat;
                    const gainedHeat = Math.min(heatDiff / 4 + 10, heatDiff);

                    simulator.addComponentHeat(neighbourPosition, -gainedHeat);
                    simulator.addComponentHeat(componentPosition, gainedHeat);
                }
            }
        }

        class ReactorHeatAbsorber extends ReactorComponent {
            constructor() {
                super("absorber.png");
            }

            tick(reactorLayout, componentPosition, simulator) {
                let sumRemovedHeat = 0;

                for (const neighbourPosition of reactorLayout.getComponentNeighbours(componentPosition)) {
                    if (simulator.getComponentHeat(neighbourPosition) <= 0) {
                        continue;
                    }

                    simulator.addComponentHeat(neighbourPosition, -ABSORBER_RATE);
                    sumRemovedHeat += ABSORBER_RATE;
                }

                if (sumRemovedHeat > 0) {
                    simulator.coolantConsumed += reactorLayout.stackHeight;
                }
            }
        }

        class ReactorHeatVent extends ReactorComponent {
            constructor() {
                super("vent.png");
            }

            tick(reactorLayout, componentPosition, simulator) {
                let hottestNeighbourPosition = null;
                let hottestNeighbourHeat = 0;

                for (const neighbourPosition of reactorLayout.getComponentNeighbours(componentPosition)) {
                    const neighbourHeat = simulator.getComponentHeat(neighbourPosition);

                    if (neighbourHeat > hottestNeighbourHeat) {
                        hottestNeighbourHeat = neighbourHeat;
                        hottestNeighbourPosition = neighbourPosition;
                    }
                }

                if (hottestNeighbourHeat != 0) {
                    simulator.addComponentHeat(
                        hottestNeighbourPosition,
                        -Math.min(hottestNeighbourHeat / VENT_RELATIVE_RATE + VENT_BASE_RATE, hottestNeighbourHeat)
                    );
                }
            }
        }

        let selectedReactorComponentFactory = () => new ReactorEmptyTile();
        let reactorLayout = null;
        let heatHistoryChart = null;

        function updateSelectedReactorComponentFactory() {
            const componentSelectEle = document.querySelector("#component-select");
            const selectedValue = parseInt(componentSelectEle.value);

            selectedReactorComponentFactory = [
                () => new ReactorEmptyTile(),
                () => new ReactorFuelRod(1),
                () => new ReactorFuelRod(2),
                () => new ReactorFuelRod(4),
                () => new ReactorNeutronReflector(),
                () => new ReactorHeatAbsorber(),
                () => new ReactorHeatVent(),
                () => new ReactorHeatPipe(),
            ][selectedValue];
        }

        function runSimulationAndPostResults() {
            const reactorSimulator = new ReactorSimulator(reactorLayout);
            reactorSimulator.simulate(50000);
            const simulationResults = document.querySelector("#simulation-results");

            const simulationSeconds = 50000 / 60;

            const simulationResultsText = `${reactorSimulator.rfGenerated / 50000} RF/t\n` +
                `${(reactorSimulator.coolantConsumed / 1000 / simulationSeconds).toFixed(2)} ice blocks per second\n\n` +
                `${(reactorSimulator.fuelConsumed / 4000 / simulationSeconds).toFixed(2)} uranium pellets per second, OR\n` +
                `${(reactorSimulator.fuelConsumed / 40000 / simulationSeconds).toFixed(2)} plutonium pellets per second, OR\n` +
                `${(reactorSimulator.fuelConsumed / 400 / simulationSeconds).toFixed(2)} small uranium pellets per second, OR\n` +
                `${(reactorSimulator.fuelConsumed / 4000 / simulationSeconds).toFixed(2)} small plutonium pellets per second\n`;

            simulationResults.textContent = simulationResultsText;
            
            
            textContent = (reactorSimulator.rfGenerated / 50000).toString() + " RF/t";

            const heatHistoryCanvas = document.querySelector("#heat-history");

            let heatChartGradient;
            function getHeatChartGradient(ctx, chartArea) {
                if (!heatChartGradient) {
                    heatChartGradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                    heatChartGradient.addColorStop(0, "lightblue");
                    heatChartGradient.addColorStop(0.5, "yellow");
                    heatChartGradient.addColorStop(1, "red");
                }

                return heatChartGradient;
            }

            if (heatHistoryChart) {
                heatHistoryChart.destroy();
            }

            heatHistoryChart = new Chart(heatHistoryCanvas, {
                type: "line",
                data: {
                    labels: Array.from(reactorSimulator.maxHeatHistory.keys()),
                    datasets: [
                        {
                            label: "Heat",
                            data: reactorSimulator.maxHeatHistory,
                            borderColor: function (context) {
                                const {ctx, chartArea} = context.chart;

                                if (!chartArea) {
                                    return;
                                }

                                return getHeatChartGradient(ctx, chartArea);
                            }
                        }
                    ]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            min: 0,
                            max: 2000
                        }
                    }
                }
            });
        }

        function replaceLayout() {
            const widthInput = document.querySelector("#width-input");
            const heightInput = document.querySelector("#height-input");
            const stackHeightInput = document.querySelector("#stack-height-input");

            reactorLayout = new ReactorLayout(
                parseInt(widthInput.value),
                parseInt(heightInput.value),
                parseInt(stackHeightInput.value)
            );

            document.querySelector("#reactor-layout-wrapper").replaceChildren(reactorLayout.getHtmlLayout());
            runSimulationAndPostResults();
        }

        function updateConfig() {
            const rfPerPulseInput = document.querySelector("#rf-per-pulse-input");
            const absorberRateInput = document.querySelector("#absorber-rate-input");
            const ventBaseRateInput = document.querySelector("#vent-base-rate-input");
            const ventRelativeRateInput = document.querySelector("#vent-relative-rate-input");

            RF_PER_PULSE = parseInt(rfPerPulseInput.value);
            ABSORBER_RATE = parseInt(absorberRateInput.value);
            VENT_BASE_RATE = parseInt(ventBaseRateInput.value);
            VENT_RELATIVE_RATE = parseInt(ventRelativeRateInput.value);
        }

        replaceLayout();
        updateConfig();
    </script>
    <style>
        body {
            background-color: rgb(29, 29, 29);
            color: white;
            font-family: monospace;
        }

        #configuration {
            display: flex;
            flex-direction: row;
            justify-content: left;
            gap: 50px;
        }

        #reactor-layout {
            border: 1px solid lightgray;
            border-collapse: collapse;
        }
        
        .reactor-component {
            border: 1px dashed gray;
            background-color: rgb(61, 61, 61);
            width: 32px;
            height: 32px;
            background-image: url("empty.png");
            image-rendering: pixelated;
            background-size: cover;
        }
    </style>
</html>